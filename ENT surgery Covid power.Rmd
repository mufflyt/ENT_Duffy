---
title: "Covid ENT surgeries"
date: "August 1, 2021"
output:
  pdf_document: default
  html_document: default
---

```{r message=FALSE, warning=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(rstatix)
library(pwr)
```

```{r}
d_site <- read_excel("procedure_by_site.xlsx")
d <- read_excel("overall_count.xlsx")
head(d_site)
head(d)
```

Question 1: Was there a difference in the total number of ear, nose, and throat cases performed before and after the COVID-19 pandemic?

1-Convert data to long format
```{r}
d_long <- gather(d, covid_status, surgeries_count, Precovid:Postcovid, factor_key=TRUE)
head(d_long)
```

```{r}
s1 <- group_by(d_long, covid_status) %>%
  summarise(
    count = n(),
    mean = mean(surgeries_count, na.rm = TRUE),
    sd = sd(surgeries_count, na.rm = TRUE)
  )
s1
```

Sample size calculation

1-calculate effect size using Cohen formula
```{r}
d_long %>% cohens_d(surgeries_count ~ covid_status, var.equal = FALSE)
```

2- calculate the sample size
```{r}
pwr.t.test(n = NULL, d = 0.35, sig.level = 0.05, power = 0.8, type = "two.sample")
```


2- Perform t-test in R.

```{r}
test <- t.test(d_long$surgeries_count ~ d_long$covid_status)
test
```

3-Shapiro-wilk normality test.

```{r}
with(d_long, shapiro.test(surgeries_count[covid_status == "Precovid"]))
with(d_long, shapiro.test(surgeries_count[covid_status == "Postcovid"]))
```

4- Wilcox test
```{r}
wilcox.test(d$Precovid, d$Postcovid, alternative = "two.sided")
```



Question 2: Was there a statistically significant decrease in ear, nose, and throat cases before and after COVID-19 in one institution compared to another institution? There are six institutions: CU (University of Colorado), UCSF (University of California San Francisco). Georgetown, Harvard, KU (University of Kansas), and LSU (Louisiana State University).



1- Two-way ANOVA test
```{r}
res.aov <- aov(surgeries_count ~ covid_status * Site, data = d_long)
summary(res.aov)
```



Question 3: If there was a difference in cases between institutions, was there a difference in the procedure type performed? Examples of procedure types are head_neck_cancer, otology_audiology, facial_plastic_reconstructive_surgery, and General_peds.

```{r}
head(d_site)
```

1- Convert data to long format.

```{r}
d2_long <- gather(d_site, covid_status, surgeries_count, Precovid:Postcovid, factor_key=TRUE)
head(d2_long)
```

2- Two-way ANOVA
```{r}
res.aov2 <- aov(surgeries_count ~ covid_status * Category, data = d2_long)
summary(res.aov2)
```

```{r}
TukeyHSD(res.aov2, which = "covid_status:Category")
```


Question 4: Overall, there is a difference in ENT case volume between the types of hospitals where university hospitals do a statistically larger number of cases than a county, VA, or Children’s hospitals (p<0.01). Was there a statistically significant decrease in the cases explained by the different types of hospitals? (e.g., county, VA, university, or Children’s hospitals)

1- ANOVA test

```{r}
res.aov3 <- aov(surgeries_count ~ Hospital_type, data = d_long)
summary(res.aov3)
```

2-Tukey test

```{r}
TukeyHSD(res.aov3)
```

3- Shapiro wilk normality test
```{r}
# Extract the residuals
aov_residuals <- residuals(object = res.aov3 )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )
```

4- Kruskal walis test
```{r}
kruskal.test(surgeries_count ~ Hospital_type, data = d_long)
```

5- pairwise Wilcox test
```{r}
p <- pairwise.wilcox.test(d_long$surgeries_count, d_long$Hospital_type,
                 p.adjust.method = "BH")
p <- as.data.frame(p$p.value)
p
```














